{% extends 'visualization/dashboard.html' %}
{% load staticfiles %}
{% block title %}
<title>Test Mapa</title>
{% endblock title %}

{% block topimports %}
<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.0-rc.3/dist/leaflet.css"/>
<!-- Marker Cluster Style -->
<link href="{% static 'components/leaflet.markercluster/dist/MarkerCluster.css' %}" rel="stylesheet">
<!-- Leaflet Scripts -->
<script src="https://unpkg.com/leaflet@1.0.0-rc.3/dist/leaflet.js"></script>

<script src="{% static 'js/Leaflet.GTFS.js' %}"></script>

<!-- markercluster Script -->
<script src="{% static 'components/leaflet.markercluster/dist/leaflet.markercluster.js' %}"></script>
<script src="http://200.9.100.91:8080/gpsonline/static/js/Leaflet.polylineDecorator.js"></script>

<style>
    .map {
        height: 600px;
    }
</style>
{% endblock topimports %}

{% block toptiles %}
{% endblock toptiles %}

{% block maincontent %}
<div class="row">
    <div class="col-md-12 col-sm-12 col-xs-12">
        <div class="x_panel">
            <div class="x_title">
                <h2>Mapa</h2>
                <ul class="nav navbar-right panel_toolbox">
                    <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                    </li>
                </ul>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div class="dashboard-widget-content">
                    <div class="container">

                        <div class="container-fluid" style="height: 100%;min-height: 100%">
                            <div class="row" style="height: 100%;min-height: 100%">
                                <div class="col-md-3">
                                    <div class="panel panel-default">
                                        <div class="panel-heading">
                                            <h3 class="panel-title">Servicio</h3>
                                        </div>
                                        <div class="panel-body">
                                            <div class="form-inline">
                                                <input id="serviceCode1" type="text" class="form-control"
                                                       placeholder="Ingresar servicio aquí...">
                                                <label class="radio-inline">
                                                    <input type="radio" name="direction1" id="optionsRadios1" value="R"
                                                           checked>
                                                    REGRESO
                                                </label>
                                                <label class="radio-inline">
                                                    <input type="radio" name="direction1" id="optionsRadios2" value="I">
                                                    IDA
                                                </label>
                                                <hr/>
                                                <input type="button" id="seeBuses1" value="Ver servicio"
                                                       class="btn btn-default"/>
                                                <hr/>
                                                <div class="form-group">
                                                    <label class="control-label">Origen:</label>
                                                    <p id="serviceOrigin1" type="text" class="form-control-static"></p>
                                                </div>
                                                <div class="form-group">
                                                    <label class="control-label">Destino:</label>
                                                    <p id="serviceDestination1" type="text"
                                                       class="form-control-static"></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="panel panel-default">
                                        <div class="panel-heading">
                                            <h3 class="panel-title">Servicio</h3>
                                        </div>
                                        <div class="panel-body">
                                            <div class="form-inline">
                                                <input id="serviceCode2" type="text" class="form-control"
                                                       placeholder="Ingresar servicio aquí...">
                                                <label class="radio-inline">
                                                    <input type="radio" name="direction2" id="optionsRadios1" value="R"
                                                           checked>
                                                    REGRESO
                                                </label>
                                                <label class="radio-inline">
                                                    <input type="radio" name="direction2" id="optionsRadios2" value="I">
                                                    IDA
                                                </label>
                                                <hr/>
                                                <input type="button" id="seeBuses2" value="Ver servicio"
                                                       class="btn btn-default"/>
                                                <hr/>
                                                <div class="form-group">
                                                    <label class="control-label">Origen:</label>
                                                    <p id="serviceOrigin2" type="text" class="form-control-static"></p>
                                                </div>
                                                <div class="form-group">
                                                    <label class="control-label">Destino:</label>
                                                    <p id="serviceDestination2" type="text"
                                                       class="form-control-static"></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-9" style="height: 100%;min-height: 100%">
                                    <div id="mapid" class="map">
                        </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock maincontent %}

{% block bottomimports %}
<!--<script>

    var map;
    map = L.map('mapa').setView([-33.45, -70.65], 11);
    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 18,
        id: 'transappvis.1gj7fib9',
        accessToken: 'pk.eyJ1IjoidHJhbnNhcHB2aXMiLCJhIjoiY2l0bG9qd3ppMDBiNjJ6bXBpY3J0bm40cCJ9.ajifidV4ypi0cXgiGQwR-A'
    }).addTo(map);
    //var markers = L.markerClusterGroup();
    for (var i = 0; i < data.length; i++) {
        L.marker([data[i].longitude, data[i].latitude]).addTo(map).bindPopup(data[i].eyeColor);
    }
</script>-->
<script>
    $(document).ready(function () {
        /**
         * SET MAP
         */
        var beauchefLocation = L.latLng(-36.9554,  -73.0202);
        var map = L.map("mapid", {editable: true}).setView(beauchefLocation, 15);


        var routeLayer1 = L.featureGroup([]);
        var busStopsLayer1 = L.layerGroup([]);
        var routeLayer2 = L.featureGroup([]);
        var busStopsLayer2 = L.layerGroup([]);
        var commonBusStopsLayer = L.layerGroup([]);

        var overlays = {
            "servicio 1": routeLayer1,
            "paradas 1": busStopsLayer1,
            "servicio 2": routeLayer2,
            "paradas 2": busStopsLayer2,
            "paradas comunes": commonBusStopsLayer
        };
        L.control.layers({}, overlays).addTo(map);

        function drawRoute(service, direction, busStopsLayer, routeLayer) {
            // draw bus stops related to service
            busStopsLayer = GTFS.drawStopsForService(busStopsLayer, service, direction);

            // draw route
            var routes = GTFS.getRoutes([service + direction]);
            console.log(routes);
            GTFS.drawRoutes(routeLayer, routes);

            var line = [];
            $.each(routes[0].route, function (i, v) {
                line.push([v.latitud, v.longitud]);
            });

            var routeWithArrows = L.polylineDecorator(line, {
                patterns: [
                    {
                        offset: 0,
                        endOffset: 0,
                        repeat: '40',
                        symbol: L.Symbol.arrowHead(
                                {
                                    pixelSize: 10,
                                    polygon: true,
                                    pathOptions: {
                                        fillOpacity: 1,
                                        color: GTFS.getRouteColor(service),
                                        stroke: true
                                    }
                                })
                    }
                ]
            });
            var popupMessage = "<h4>" + service + direction + "</h4>";
            routeWithArrows.bindPopup(popupMessage);
            routeLayer.bindPopup(popupMessage);

            routeLayer.addLayer(routeWithArrows);
            routeLayer.addTo(map);
            //busStopsLayer.addTo(map);

            map.fitBounds(routeLayer.getBounds());

            drawCommonBusStops(commonBusStopsLayer);

            console.log("Map updated with service: " + service + direction);
        };

        function drawCommonBusStops(busStopsLayer) {
            var serviceCode1 = $("#serviceCode1").val();
            var direction1 = $("input[name=direction1]:checked").val();
            var serviceCode2 = $("#serviceCode2").val();
            var direction2 = $("input[name=direction2]:checked").val();

            var stopsData1 = GTFS.data.service[serviceCode1]["stops" + direction1].split('-');
            var stopsData2 = GTFS.data.service[serviceCode2]["stops" + direction2].split('-');

            var commonValues = stopsData1.filter(function (value) {
                return stopsData2.indexOf(value) > -1;
            });

            GTFS.drawStops(busStopsLayer, commonValues);
            busStopsLayer.addTo(map);
        }

        /**
         * LOAD DATA
         */
        GTFS.loadData(function () {
            var baseLayer = GTFS.setLayerControl(map);
            // SET BUTTON ACTION
            var drawServiceButton1 = $("#seeBuses1");
            var drawServiceButton2 = $("#seeBuses2");

            var clickFunction = function (e) {
                var index = $(e.target).attr('id').substr(-1);
                var serviceCode = $("#serviceCode" + index).val();
                var direction = $("input[name=direction" + index + "]:checked").val();

                if (index == 1) {
                    drawRoute(serviceCode, direction, busStopsLayer1, routeLayer1);
                } else {
                    drawRoute(serviceCode, direction, busStopsLayer2, routeLayer2);
                }

                var serviceInfo = GTFS.data.service[serviceCode];
                var origin = serviceInfo.origin;
                var destination = serviceInfo.destiny;
                if (direction == "I") {
                    $("#serviceOrigin" + index).text(origin);
                    $("#serviceDestination" + index).text(destination);
                } else {
                    $("#serviceOrigin" + index).text(destination);
                    $("#serviceDestination" + index).text(origin);
                }
            };

            drawServiceButton1.click(clickFunction);
            drawServiceButton2.click(clickFunction);

            // press enter on serviceCode input
            var keyPressFunction = function (e) {
                var key = e.which;
                // the enter key code
                if (key == 13) {
                    var index = $(e.target).attr('id').substr(-1);
                    $('#seeBuses' + index).trigger("click");
                    return false;
                }
            }
            $("#serviceCode1").keypress(keyPressFunction);
            $("#serviceCode2").keypress(keyPressFunction);

            // change radio button
            $("input[type=radio][name=direction1]").change(function () {
                if ($("#serviceCode1").val()) {
                    drawServiceButton1.trigger("click");
                }
            });
            $("input[type=radio][name=direction2]").change(function () {
                if ($("#serviceCode2").val()) {
                    drawServiceButton2.trigger("click");
                }
            });
        }, "/static/", "dataconce");
    });
</script>
{% endblock bottomimports %}